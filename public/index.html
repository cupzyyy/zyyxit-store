<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZyyXit - Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        
        @keyframes checkmark {
            0% { stroke-dashoffset: 100; }
            100% { stroke-dashoffset: 0; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        
        .pulse-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid #10B981;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        .checkmark-path {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: checkmark 0.6s ease-in-out forwards;
        }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Gradient Background */
        .bg-gradient-mesh {
            background: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: 100% 100%;
        }
        
        /* QRIS Container Pattern */
        .qris-pattern {
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- Background Decoration -->
    <div class="fixed inset-0 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 opacity-5 pointer-events-none"></div>
    
    <!-- Main Container -->
    <div class="relative min-h-screen flex items-center justify-center p-4">
        
        <!-- Card Container -->
        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-16 -mt-16"></div>
                <div class="absolute bottom-0 left-0 w-24 h-24 bg-white opacity-10 rounded-full -ml-12 -mb-12"></div>
                
                <h1 class="text-2xl font-bold relative z-10">üõí ZyyXit</h1>
                <p class="text-indigo-100 text-sm mt-1 relative z-10">Pembayaran Otomatis dengan QRIS</p>
            </div>

            <!-- Content -->
            <div class="p-6 space-y-6">
                
                <!-- Form Order -->
                <div id="orderForm" class="space-y-4">
                    
                    <!-- Nama -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                        <input type="text" id="buyerName" placeholder="Masukkan nama Anda" 
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none"
                            required>
                    </div>

                    <!-- Email (WhatsApp/Email) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email / No WhatsApp</label>
                        <input type="text" id="buyerEmail" placeholder="email@example.com atau 08123456789" 
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none"
                            required>
                    </div>

                    <!-- Pilih Produk -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Produk</label>
                        <select id="productSelect" 
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none bg-white"
                            required>
                            <option value="">-- Pilih Produk --</option>
                            <option value="vip-1day" data-price="5000">‚≠ê VIP Member 1 Hari - Rp 5.000</option>
                            <option value="vip-7day" data-price="25000">üåü VIP Member 7 Hari - Rp 25.000</option>
                            <option value="vip-30day" data-price="75000">üíé VIP Member 30 Hari - Rp 75.000</option>
                            <option value="coin-100" data-price="10000">ü™ô 100 Koin - Rp 10.000</option>
                            <option value="coin-500" data-price="45000">üí∞ 500 Koin - Rp 45.000</option>
                            <option value="coin-1000" data-price="80000">üèÜ 1000 Koin - Rp 80.000</option>
                            <option value="script-basic" data-price="50000">ü§ñ Script Bot Basic - Rp 50.000</option>
                            <option value="script-pro" data-price="150000">üöÄ Script Bot Pro - Rp 150.000</option>
                            <option value="ebook-trading" data-price="35000">üìö E-Book Trading - Rp 35.000</option>
                            <option value="voucher-game" data-price="52000">üéÆ Voucher Game 50K - Rp 52.000</option>
                            <option value="pulsa-10k" data-price="12000">üì± Pulsa 10.000 - Rp 12.000</option>
                            <option value="pulsa-25k" data-price="27000">üì≤ Pulsa 25.000 - Rp 27.000</option>
                        </select>
                    </div>

                    <!-- Jumlah -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Order</label>
                        <div class="flex items-center space-x-3">
                            <button onclick="changeQty(-1)" class="w-10 h-10 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
                            </button>
                            <input type="number" id="quantity" value="1" min="1" max="99" readonly
                                class="w-20 text-center px-3 py-2 rounded-lg border border-gray-300 font-semibold text-gray-800">
                            <button onclick="changeQty(1)" class="w-10 h-10 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Total Harga -->
                    <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-100">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Total Pembayaran</span>
                            <span id="totalPrice" class="text-2xl font-bold text-indigo-600">Rp 0</span>
                        </div>
                    </div>

                    <!-- Button Order -->
                    <button onclick="createOrder()" id="btnOrder"
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold py-4 rounded-lg shadow-lg transform transition-all hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center space-x-2">
                        <span>Order Sekarang</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
                    </button>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="hidden text-center py-8">
                    <div class="relative w-16 h-16 mx-auto mb-4">
                        <div class="absolute inset-0 border-4 border-indigo-200 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin-slow"></div>
                    </div>
                    <p class="text-gray-600 font-medium">Membuat pesanan...</p>
                    <p class="text-sm text-gray-400 mt-1">Mohon tunggu sebentar</p>
                </div>

                <!-- Payment State (QRIS) -->
                <div id="paymentState" class="hidden space-y-4">
                    <!-- Status Badge -->
                    <div class="flex items-center justify-center space-x-2">
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
                        </span>
                        <span id="statusText" class="text-sm font-medium text-yellow-600">Menunggu Pembayaran</span>
                    </div>

                    <!-- QRIS Container -->
                    <div class="bg-white rounded-xl border-2 border-gray-200 p-4 qris-pattern relative">
                        <div class="absolute top-2 right-2">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">QRIS</span>
                        </div>
                        <div class="bg-white p-2 rounded-lg shadow-inner">
                            <img id="qrisImage" src="" alt="QRIS Code" class="w-full h-auto mx-auto">
                        </div>
                    </div>

                    <!-- Nominal -->
                    <div class="text-center">
                        <p class="text-sm text-gray-500">Nominal Pembayaran</p>
                        <p id="paymentAmount" class="text-2xl font-bold text-gray-800">Rp 0</p>
                    </div>

                    <!-- Countdown -->
                    <div class="bg-gray-100 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-500 mb-1">Bayar sebelum</p>
                        <p id="expiryTime" class="text-sm font-mono font-semibold text-gray-700">--:--:--</p>
                    </div>

                    <!-- Cancel Button -->
                    <button onclick="resetOrder()" class="w-full py-3 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors text-sm">
                        Batalkan Pesanan
                    </button>
                </div>

                <!-- Success State -->
                <div id="successState" class="hidden text-center py-6 space-y-4">
                    <!-- Success Animation -->
                    <div class="relative w-24 h-24 mx-auto pulse-ring">
                        <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center">
                            <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path class="checkmark-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-1">Pembayaran Berhasil! üéâ</h2>
                        <p class="text-gray-600">Order Anda sedang diproses otomatis</p>
                    </div>

                    <!-- Order Details -->
                    <div class="bg-green-50 rounded-lg p-4 text-left space-y-2 border border-green-100">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Order ID</span>
                            <span id="successOrderId" class="font-mono font-medium text-gray-800">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Produk</span>
                            <span id="successProduct" class="font-medium text-gray-800">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Delivery Code</span>
                            <span id="successCode" class="font-mono font-medium text-green-600">-</span>
                        </div>
                    </div>

                    <button onclick="resetOrder()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        Order Lagi
                    </button>
                </div>

                <!-- Error State -->
                <div id="errorState" class="hidden text-center py-6 space-y-4">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Terjadi Kesalahan</h3>
                        <p id="errorMessage" class="text-sm text-gray-600 mt-1">Silakan coba lagi</p>
                    </div>
                    <button onclick="resetOrder()" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-semibold py-3 rounded-lg transition-colors">
                        Coba Lagi
                    </button>
                </div>

            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100">
                <div class="flex items-center justify-center space-x-2 text-xs text-gray-400">
                    <span>üîí Pembayaran Aman</span>
                    <span>‚Ä¢</span>
                    <span>Powered by Pakasir</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        let currentOrder = null;
        let checkInterval = null;
        let expiryInterval = null;

        // ==================== DOM ELEMENTS ====================
        const els = {
            orderForm: document.getElementById('orderForm'),
            loadingState: document.getElementById('loadingState'),
            paymentState: document.getElementById('paymentState'),
            successState: document.getElementById('successState'),
            errorState: document.getElementById('errorState'),
            btnOrder: document.getElementById('btnOrder'),
            productSelect: document.getElementById('productSelect'),
            quantity: document.getElementById('quantity'),
            totalPrice: document.getElementById('totalPrice'),
            qrisImage: document.getElementById('qrisImage'),
            paymentAmount: document.getElementById('paymentAmount'),
            statusText: document.getElementById('statusText'),
            expiryTime: document.getElementById('expiryTime'),
            buyerName: document.getElementById('buyerName'),
            buyerEmail: document.getElementById('buyerEmail'),
            successOrderId: document.getElementById('successOrderId'),
            successProduct: document.getElementById('successProduct'),
            successCode: document.getElementById('successCode'),
            errorMessage: document.getElementById('errorMessage')
        };

        // ==================== EVENT LISTENERS ====================
        els.productSelect.addEventListener('change', updateTotal);
        els.quantity.addEventListener('change', updateTotal);
        els.quantity.addEventListener('input', updateTotal);

        // ==================== FUNCTIONS ====================

        function changeQty(delta) {
            let qty = parseInt(els.quantity.value) || 1;
            qty = Math.max(1, Math.min(99, qty + delta));
            els.quantity.value = qty;
            updateTotal();
        }

        function updateTotal() {
            const selected = els.productSelect.selectedOptions[0];
            if (!selected || !selected.dataset.price) {
                els.totalPrice.textContent = 'Rp 0';
                return;
            }
            
            const price = parseInt(selected.dataset.price);
            const qty = parseInt(els.quantity.value) || 1;
            const total = price * qty;
            
            els.totalPrice.textContent = 'Rp ' + total.toLocaleString('id-ID');
        }

        function showState(state) {
            // Hide all states
            els.orderForm.classList.add('hidden');
            els.loadingState.classList.add('hidden');
            els.paymentState.classList.add('hidden');
            els.successState.classList.add('hidden');
            els.errorState.classList.add('hidden');
            
            // Show requested state
            if (state === 'form') els.orderForm.classList.remove('hidden');
            else if (state === 'loading') els.loadingState.classList.remove('hidden');
            else if (state === 'payment') els.paymentState.classList.remove('hidden');
            else if (state === 'success') els.successState.classList.remove('hidden');
            else if (state === 'error') els.errorState.classList.remove('hidden');
        }

        async function createOrder() {
            const name = els.buyerName.value.trim();
            const email = els.buyerEmail.value.trim();
            const productId = els.productSelect.value;
            const quantity = parseInt(els.quantity.value) || 1;

            // Validation
            if (!name) return alert('Silakan masukkan nama Anda');
            if (!email) return alert('Silakan masukkan email atau nomor WhatsApp');
            if (!productId) return alert('Silakan pilih produk');

            // Disable button
            els.btnOrder.disabled = true;
            els.btnOrder.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';

            try {
                showState('loading');

                const response = await fetch('/api/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_id: productId,
                        buyer_email: email,
                        buyer_name: name,
                        quantity: quantity
                    })
                });

                const data = await response.json();

                if (!data.ok) {
                    throw new Error(data.error || 'Gagal membuat pesanan');
                }

                // Save order data
                currentOrder = {
                    orderId: data.order_id,
                    productName: data.product_name,
                    totalAmount: data.total_payment,
                    qris: data.qris,
                    expiredAt: data.expired_at
                };

                // Show QRIS
                showPaymentState(data);

            } catch (error) {
                console.error('Order Error:', error);
                els.errorMessage.textContent = error.message;
                showState('error');
            } finally {
                els.btnOrder.disabled = false;
                els.btnOrder.innerHTML = `<span>Order Sekarang</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>`;
            }
        }

        function showPaymentState(data) {
            // Generate QRIS Image from string
            // Using QRServer API to generate QR code from QRIS string
            const qrisUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(data.qris)}`;
            
            els.qrisImage.src = qrisUrl;
            els.paymentAmount.textContent = 'Rp ' + data.total_payment.toLocaleString('id-ID');
            
            showState('payment');

            // Start countdown if expired_at exists
            if (data.expired_at) {
                startCountdown(data.expired_at);
            }

            // Start status checking every 5 seconds
            startStatusCheck(data.order_id);
        }

        function startCountdown(expiredAt) {
            const expiry = new Date(expiredAt).getTime();
            
            if (expiryInterval) clearInterval(expiryInterval);
            
            expiryInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = expiry - now;
                
                if (distance < 0) {
                    clearInterval(expiryInterval);
                    els.expiryTime.textContent = 'EXPIRED';
                    els.expiryTime.classList.add('text-red-500');
                    return;
                }
                
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                els.expiryTime.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function startStatusCheck(orderId) {
            // Check immediately
            checkStatus(orderId);
            
            // Then every 5 seconds
            checkInterval = setInterval(() => {
                checkStatus(orderId);
            }, 5000);
        }

        async function checkStatus(orderId) {
            try {
                const response = await fetch('/api/check-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });

                const data = await response.json();

                if (!data.ok) {
                    console.log('Status check failed:', data.error);
                    return;
                }

                const status = data.status;
                const order = data.order;

                console.log('Status check:', status);

                if (status === 'paid' || status === 'delivered') {
                    // Payment success!
                    clearInterval(checkInterval);
                    if (expiryInterval) clearInterval(expiryInterval);
                    
                    showSuccessState(order);
                } else if (status === 'expired' || status === 'failed' || status === 'cancelled') {
                    // Payment failed/expired
                    clearInterval(checkInterval);
                    if (expiryInterval) clearInterval(expiryInterval);
                    
                    els.statusText.textContent = 'Pembayaran ' + status.toUpperCase();
                    els.statusText.className = 'text-sm font-medium text-red-600';
                    
                    setTimeout(() => {
                        els.errorMessage.textContent = `Pembayaran ${status}. Silakan order ulang.`;
                        showState('error');
                    }, 2000);
                }
                // If pending, continue checking...

            } catch (error) {
                console.error('Status check error:', error);
            }
        }

        function showSuccessState(order) {
            els.successOrderId.textContent = order.order_id;
            els.successProduct.textContent = order.product_name;
            els.successCode.textContent = order.delivery_code || 'Processing...';
            
            showState('success');
        }

        function resetOrder() {
            // Clear intervals
            if (checkInterval) clearInterval(checkInterval);
            if (expiryInterval) clearInterval(expiryInterval);
            
            // Reset form
            els.buyerName.value = '';
            els.buyerEmail.value = '';
            els.productSelect.value = '';
            els.quantity.value = 1;
            updateTotal();
            
            // Reset states
            currentOrder = null;
            els.statusText.textContent = 'Menunggu Pembayaran';
            els.statusText.className = 'text-sm font-medium text-yellow-600';
            els.expiryTime.classList.remove('text-red-500');
            
            showState('form');
        }

        // Initialize
        updateTotal();
    </script>
</body>
</html>
